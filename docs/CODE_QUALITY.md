# Code Quality Tools

This document describes the code quality tools configured for this project and how to use them.

## Overview

The project uses two primary tools for maintaining code quality:
- **clang-format**: Automatic code formatting
- **clang-tidy**: Static analysis and linting

Both tools are integrated with:
1. Pre-commit hooks (recommended for development)
2. CMake targets (for manual runs)

## Configuration Files

### .clang-format
Located at the project root, this file configures automatic code formatting based on Google C++ Style Guide with customizations:
- **Base Style**: Google
- **Indent Width**: 4 spaces
- **Column Limit**: 120 characters
- **Standard**: C++20
- **Pointer Alignment**: Left (`int* ptr` not `int *ptr`)

### .clang-tidy
Located at the project root, this file configures static analysis checks:
- **Enabled Check Categories**:
  - `bugprone-*`: Bug-prone code patterns
  - `concurrency-*`: Concurrency issues
  - `cppcoreguidelines-*`: C++ Core Guidelines
  - `modernize-*`: Modern C++ features
  - `performance-*`: Performance improvements
  - `portability-*`: Portability issues
  - `misc-*`: Miscellaneous checks

- **Disabled Checks** (for LeetCode context):
  - Magic numbers (common in examples)
  - Identifier naming (flexible for problem-solving)
  - Named parameters (not always needed)
  - Internal linkage suggestions (test macros)

## Using Pre-commit Hooks (Recommended)

Pre-commit hooks automatically check your code before each commit.

### Installation
```bash
# Install pre-commit (if not already installed)
pip install pre-commit

# Install the git hooks
pre-commit install
```

### Usage
Pre-commit runs automatically on `git commit`. To run manually:

```bash
# Run on all files
pre-commit run --all-files

# Run only clang-format
pre-commit run clang-format --all-files

# Run only clang-tidy
pre-commit run clang-tidy --all-files
```

### What Gets Checked
1. **Trailing whitespace removal**
2. **End-of-file fixer**
3. **YAML syntax validation**
4. **Large file detection**
5. **clang-format** (auto-formats C/C++ files)
6. **clang-tidy** (static analysis, excludes lib/ and design_pattern/)

## Using CMake Targets

CMake targets allow running the tools independently of git.

### Build the Project First
```bash
# Generate build files and compile
cmake --workflow --preset x64-Darwin-Debug
```

This creates `compile_commands.json` needed for clang-tidy.

### Run clang-format
```bash
# Format all source files in-place
make -C out/build/x64-Darwin-Debug clang-format
```

### Run clang-tidy
```bash
# Run static analysis on all source files
make -C out/build/x64-Darwin-Debug clang-tidy
```

**Note**: The clang-tidy CMake target is stricter than pre-commit and may report warnings in test files. This is expected and doesn't block commits.

## Compilation Database

clang-tidy requires `compile_commands.json` to understand include paths and compiler flags.

- **Generated by**: CMake with `CMAKE_EXPORT_COMPILE_COMMANDS=ON`
- **Location**: `out/build/x64-Darwin-Debug/compile_commands.json`
- **Symlink**: Project root has a symlink for convenience
- **Git**: Symlink is ignored via `.gitignore`

To regenerate:
```bash
cmake --workflow --preset x64-Darwin-Debug
```

## Workflow Recommendations

### Daily Development
1. Install pre-commit hooks once: `pre-commit install`
2. Write code normally
3. Commit as usual - hooks run automatically
4. If formatting issues are found, they're auto-fixed
5. If linting issues are found, review and fix them

### Manual Code Cleanup
```bash
# Format all code
make -C out/build/x64-Darwin-Debug clang-format

# Or use pre-commit
pre-commit run clang-format --all-files
```

### Before Pull Requests
```bash
# Run all checks
pre-commit run --all-files

# Build and test
cmake --workflow --preset x64-Darwin-Debug
```

## Customizing Checks

### Disabling Specific Warnings

Add comments in code:
```cpp
// NOLINT - disable all checks for this line
int x = 42;  // NOLINT

// NOLINTNEXTLINE - disable all checks for next line
// NOLINTNEXTLINE
int y = 42;

// Disable specific check
int z = 42;  // NOLINT(readability-magic-numbers)
```

### Updating .clang-tidy

Edit `.clang-tidy` to add/remove checks:
```yaml
Checks: >
  -*,
  bugprone-*,
  -bugprone-easily-swappable-parameters,  # Disable this check
  performance-*,
  my-new-check-*  # Enable new check category
```

## Troubleshooting

### Pre-commit fails with "compile_commands.json not found"
```bash
# Rebuild project to regenerate
cmake --workflow --preset x64-Darwin-Debug
```

### clang-format/clang-tidy not found
```bash
# macOS with Homebrew
brew install llvm
# Add to PATH if needed
export PATH="/opt/homebrew/opt/llvm/bin:$PATH"
```

### Pre-commit hooks not running
```bash
# Reinstall hooks
pre-commit install
```

### Too many clang-tidy warnings
This is normal - clang-tidy is comprehensive. Pre-commit configuration excludes test files and external libraries to reduce noise.

## Files Modified

- `.clang-format` - Formatting rules
- `.clang-tidy` - Linting rules
- `.pre-commit-config.yaml` - Pre-commit hook configuration
- `cmake/ClangCxxDevTools.cmake` - CMake targets for tools
- `.gitignore` - Ignore compile_commands.json symlink
- `CMakePresets.json` - Enable CMAKE_EXPORT_COMPILE_COMMANDS
- `compile_commands.json` - Symlink to build directory (created automatically)

## References

- [clang-format documentation](https://clang.llvm.org/docs/ClangFormat.html)
- [clang-tidy documentation](https://clang.llvm.org/extra/clang-tidy/)
- [pre-commit framework](https://pre-commit.com/)
- [Google C++ Style Guide](https://google.github.io/styleguide/cppguide.html)
- [C++ Core Guidelines](https://isocpp.github.io/CppCoreGuidelines/CppCoreGuidelines)
